name: Windows RDP

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Enable RDP + Disable NLA
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0

    - name: Create Autologin User
      run: |
        $username = "RDP"
        $password = "12345678"
        net user /add $username $password
        net localgroup administrators $username /add
        reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v AutoAdminLogon /t REG_SZ /d 1 /f
        reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultUsername /t REG_SZ /d $username /f
        reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultPassword /t REG_SZ /d $password /f

    - name: Download & Setup Ngrok
      run: |
        Invoke-WebRequest -Uri https://bin.ngrok.com/windows/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -DestinationPath $env:USERPROFILE\ngrok -Force
        cd $env:USERPROFILE\ngrok
        .\ngrok.exe config add-authtoken $env:NGROK_AUTH_TOKEN

    - name: Start Ngrok Tunnel (TCP 3389)
      run: |
        cd $env:USERPROFILE\ngrok
        Start-Process .\ngrok.exe "tcp 3389"
        Start-Sleep -Seconds 10
        Invoke-WebRequest -Uri http://127.0.0.1:4040/api/tunnels -OutFile ngrok.json
        Get-Content ngrok.json

    - name: Show Access Info
      run: |
        Write-Output "===================="
        Write-Output "âœ… RDP Ready!"
        Write-Output "Username: RDP"
        Write-Output "Password: 12345678"
        Write-Output "Ngrok address is shown above (look for tcp://... in ngrok.json)"
        Write-Output "===================="
