name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable RDP + Disable NLA
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Create Autologin User
        run: |
          $username = "RDP"
          $password = "882188Adriel"
          net user $username $password /add
          net localgroup administrators $username /add
          reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v AutoAdminLogon /t REG_SZ /d 1 /f
          reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultUsername /t REG_SZ /d $username /f
          reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultPassword /t REG_SZ /d $password /f

      - name: Install NVIDIA GPU Drivers
        run: |
          Invoke-WebRequest -Uri https://us.download.nvidia.com/Windows/Quadro_Certified/537.13/537.13-quadro-rtx-desktop-notebook-win10-win11-64bit-international-dch-whql.exe -OutFile driver.exe
          Start-Process .\driver.exe -ArgumentList "/s" -Wait

      - name: Ultra Optimize Windows Performance
        run: |
          powercfg -setactive SCHEME_MIN
          bcdedit /set useplatformclock true
          bcdedit /set disabledynamictick yes
          bcdedit /set tscsyncpolicy Enhanced

      - name: Install Tailscale
        run: |
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile tailscale.exe
          Start-Process .\tailscale.exe -ArgumentList "/quiet" -Wait

      - name: Establish Tailscale Connection
        run: |
          Start-Process "C:\Program Files\Tailscale\tailscale.exe" -ArgumentList "up --authkey %TAILSCALE_AUTHKEY% --hostname=github-rdp" -Wait

      - name: Show Access Info
        run: |
          Write-Output "Conecte via Tailscale para acessar a VM"
